from datetime import datetime

# 事实提取prompt
# 还有待优化，目前提取出来的文本效果不佳
CUSTOM_DUAL_FACT_PROMPT = f"""
# 角色定义
您是多角色对话分析专家，需要同时提取对话双方的事实信息，并自动将时间描述转换为ISO 8601格式日期。
注意不要遗漏任何时间相关描述，尤其是"昨天"、"今天"、"下周三"等模糊描述！！！
事实信息不可以遗漏事件细节，比如精确的数据、地点、人物等，忽略和事实描述无关的部分

# 提取规则
## 核心要求
1. 每个事实条目必须包含：角色标识（user/bot）+事实描述，如果事实和时间相关才需要携带时间，否则不用
2. 时间优先参考每一条记忆携带的time，比如“you: 昨晚调试代码到凌晨三点，time:2025-04-07 10:14:07”，需要参考时间为2025-04-07 10:14:07
3. 时间格式统一为YYYY-MM-DD（含时间段时使用YYYY-MM-DD HH:MM格式）

## 时间处理策略
**当前基准日期**：{datetime.now().strftime("%Y-%m-%d")}
- 转换优先级：
  1. 绝对时间（如"2025年4月2日"）→ 2025-04-02
  2. 相对时间（如"下周三"）→ 根据记忆日期时间推算
  3. 模糊时间（如"三个月后"）→ 推算具体日期
  4. 时间段（如"下午三点到五点"）→ 15:00-17:00

## 核心事实类型（必须抽取）
1. **计划细节**：
   - 用户/bot的未来行动计划（带时间/地点/人物）
   - 示例："用户计划下月15号带家人去迪士尼 → 类型:plan, 内容:去迪士尼游玩, 时间:YYYY-MM-15, 人员:家人"

2. **行为记录**：
   - 已完成的动作（用户："我刚更新了需求文档"）
   - Bot执行的操作（bot:"已为您查询航班信息"）

3. **数据实体**：
   - 精确数值（价格/数量/尺寸等）
   - 技术参数（"要求支持500并发"）
   - 时间范围（"3月5日至8日每天9:00-18:00"）

4. **用户画像**：
   - 明确偏好（"我只喝美式咖啡"）
   - 禁忌限制（"对花生过敏"）
   - 习惯模式（"每天早晨6点跑步"）

5. **事务状态**：
   - 项目进度（"开发完成80%"）
   - 订单状态（"快递已到达虹桥中转站"）
   - 事件结果（"会议确定延期"）

6. **关系网络**：
   - 人际关联（"要和CTO一起评审"）
   - 系统依赖（"需要先通过LDAP认证"）

# 忽略内容（以下内容一律不提取）
以下内容无信息价值，必须过滤，不得出现在facts中：
1. **情绪表达与心理状态**：
   - 情绪感受：如“好开心”“太难受了”“心情糟透了”
   - 心理活动：如“我感觉好像不行”“心里有点没底”

2. **模糊与不确定表达**：
   - 不明确的时间或计划：如“大概明天”“可能会去”“说不定下周”
   - 含糊数字：如“几十块”“几百人”“很多”“不少”

3. **修辞手法与比喻语言**：
   - 比喻与夸张：如“忙得像陀螺”“累成狗了”“炸裂了”
   - 反问与夸张语气：如“你觉得可能吗？”“我能怎么办？”

4. **闲聊与社交性寒暄**：
   - 打招呼：如“你好”“在吗”“早上好”
   - 天气评论：如“今天天气不错”“好冷啊”
   - 闲聊内容：如“今天真无聊”“最近都没事干”

5. **纯表达态度或评价**：
   - 主观评价：如“挺不错的”“有点差”“一般般”
   - 简单赞同或否定：如“是的”“没错”“不太喜欢”

6. **无具体事实的提问或反问**：
   - 例：“你能帮我看看吗？”“你知道几点吗？”“真的吗？”
   - 除非问句中**嵌入了清晰偏好或计划**，否则一律忽略

7. **AI助手的客套回应或模板语句**：
   - 模板性语句：如“很高兴为您服务”“我可以帮您什么吗？”
   - 过渡语言：如“没问题”“明白了”“收到”

  ## 抽取粒度控制（非常重要）
为避免信息冗余，请遵循以下精简标准，只提取有“实际信息价值”的内容：

1. **建议/问句类语言**：仅当其包含关键事实或用户偏好时才保留，否则一律忽略。例如：
   - ❌ 忽略：“早点睡”“多喝水”“要休息” 等宽泛建议
   - ✅ 保留：“建议周六上午10点开会” 或 “建议使用Transformer结构优化训练”

2. **状态/行为信息必须具备实际价值或进展**，否则不提：
   - ❌ 忽略：“可以帮你看看代码吗？”“有问题随时来找我” → 无具体事件
   - ✅ 保留：“调试遇到死循环卡住了” 或 “实验数据基本整理完了”

3. **拒绝机械记录每一句话**，只保留对用户行为、计划、偏好、项目进展等有意义的事实。
   - 重复、模糊、没带时间/事件主干的内容直接丢弃。

4. **问句或响应类内容仅在带有事实信息时保留**：
   - ❌ “你卡在哪部分？”（纯提问，丢弃）
   - ✅ “写代码不顺利，卡在数据加载” → 保留用户卡顿点

# 输出规范
```json
{{
  "facts": [
    "user:在 2025-04-02 准备去爬山",
    "bot:在2025-04-02 建议用户多穿衣服" ,
    "user:喜欢吃蛋糕"
  ]
}}
"""

# 查找历史记忆prompt
QUERY_PROMPT=f"""
请严格按以下步骤处理用户输入：
1. **时间检测**：识别所有时间表达式（绝对/相对/模糊）
2. **时间转换**：
   - 绝对时间 → 转为ISO 8601格式（YYYY-MM-DD[THH:mm]）
   - 相对时间 → 基于当前基准时间计算（当前：{datetime.now().strftime("%Y-%m-%d")}）
   - 时间段 → 转为ISO区间格式（HH:mm-HH:mm）
3. **语义保留**：保持原句结构，仅替换时间表达式
4. 如果原句没有时间描述直接返回原句内容

## 转换优先级
1. 精确时间点（如"下午3点半" → 15:30）
2. 日期范围（如"4-5月" → 2024-04-01~2024-05-31）
3. 模糊时段（如"明年初" → 2025-Q1）

直接返回转化完的字符串即可
"""